<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="九天图腾,博客"><meta name="description" content="九天图腾个人博客"><meta name="author" content="九天图腾"><title>深入剖析共识性算法 Paxos | 九天图腾</title><link rel="stylesheet" href="../css/style.css"><link rel="shortcut icon" href="../images/logo.svg"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/css/font-awesome.min.css"><script id="hexo-configurations">let KEEP=window.KEEP||{};KEEP.hexo_config={hostname:"blog.yusei.zone",root:"/",language:"zh-CN",path:"search.xml"},KEEP.theme_config={toc:{enable:!0,number:!1,expand_all:!1,init_open:!1},style:{primary_color:"#0066CC",avatar:"/images/avatar.jpeg",favicon:"/images/logo.svg",article_img_align:"center",left_side_width:"260px",content_max_width:"920px",hover:{shadow:!0,scale:!0},first_screen:{enable:!0,background_img:"/images/bg.svg",description:"所谓卓越，并非指行为，而是习惯。"},scroll:{progress_bar:{enable:!0},percent:{enable:!0}}},local_search:{enable:!0,preload:!0},code_copy:{enable:!0,style:"default"},pjax:{enable:!1},lazyload:{enable:!1},version:"3.4.3"},KEEP.language_ago={second:"%s 秒前",minute:"%s 分钟前",hour:"%s 小时前",day:"%s 天前",week:"%s 周前",month:"%s 月前",year:"%s 年前"}</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="atom.xml" title="九天图腾" type="application/atom+xml">
</head><body><div class="progress-bar-container"><span class="scroll-progress-bar"></span></div><main class="page-container"><div class="page-main-content"><div class="page-main-content-top"><header class="header-wrapper"><div class="header-content"><div class="left"><a class="logo-title" href="/">九天图腾</a></div><div class="right"><div class="pc"><ul class="menu-list"><li class="menu-item"><a href="../index.html">首页</a></li><li class="menu-item"><a href="../archives">归档</a></li><li class="menu-item"><a href="../links">友链</a></li><li class="menu-item"><a href="../about">关于</a></li><li class="menu-item search search-popup-trigger"><i class="fas fa-search"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div><div class="icon-item menu-bar"><div class="menu-bar-middle"></div></div></div></div></div><div class="header-drawer"><ul class="drawer-menu-list"><li class="drawer-menu-item flex-center"><a href="../index.html">首页</a></li><li class="drawer-menu-item flex-center"><a href="../archives">归档</a></li><li class="drawer-menu-item flex-center"><a href="../links">友链</a></li><li class="drawer-menu-item flex-center"><a href="../about">关于</a></li></ul></div><div class="window-mask"></div></header></div><div class="page-main-content-middle"><div class="main-content"><div class="fade-in-down-animation"><div class="article-content-container"><div class="article-title"><span class="title-hover-animation">深入剖析共识性算法 Paxos</span></div><div class="article-header"><div class="avatar"><img src="../images/avatar.jpeg"></div><div class="info"><div class="author"><span class="name">九天图腾</span> <span class="author-label">化境期</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fas fa-edit"></i>&nbsp;2020-02-02 22:00:00 </span><span class="article-categories article-meta-item"><i class="fas fa-folder"></i>&nbsp;<ul><li><a href="../categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a>&nbsp;</li></ul></span><span class="article-tags article-meta-item"><i class="fas fa-tags"></i>&nbsp;<ul><li><a href="../tags/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a>&nbsp;</li><li>| <a href="../tags/%E5%85%B1%E8%AF%86%E6%80%A7/">共识性</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fas fa-file-word"></i>&nbsp;<span>1.8k 字</span> </span><span class="article-min2read article-meta-item"><i class="fas fa-clock"></i>&nbsp;<span>6 分钟</span> </span><span class="article-pv article-meta-item"><i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content markdown-body"><h1 id="深入剖析共识性算法-Paxos"><a href="#深入剖析共识性算法-Paxos" class="headerlink" title="深入剖析共识性算法 Paxos"></a>深入剖析共识性算法 Paxos</h1><blockquote><p>📦 本文已归档到：「<a class="link" target="_blank" rel="noopener" href="https://github.com/dunwu/blog">blog<i class="fas fa-external-link-alt"></i></a>」</p><p>Paxos 是一种基于消息传递且具有容错性的共识性（consensus）算法。</p><p>Paxos 算法解决的问题正是分布式一致性问题。在一个节点数为 N 的分布式集群中，只要半数以上的节点（N/2 + 1）还正常工作，整个系统仍可以正常工作。</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/cntotemdb/ih1@master/202106/QYrLPS.png" alt="img"></p><ul><li><a href="#%E4%B8%80paxos-%E8%83%8C%E6%99%AF">一、Paxos 背景</a></li><li><a href="#%E4%BA%8Cbasic-paxos-%E7%AE%97%E6%B3%95">二、Basic Paxos 算法</a><ul><li><a href="#%E8%A7%92%E8%89%B2">角色</a></li><li><a href="#%E7%AE%97%E6%B3%95">算法</a></li><li><a href="#%E5%AE%9E%E4%BE%8B">实例</a></li></ul></li><li><a href="#%E4%B8%89multi-paxos-%E7%AE%97%E6%B3%95">三、Multi Paxos 算法</a><ul><li><a href="#basic-paxos-%E7%9A%84%E9%97%AE%E9%A2%98">Basic Paxos 的问题</a></li><li><a href="#multi-paxos-%E7%9A%84%E6%94%B9%E8%BF%9B">Multi Paxos 的改进</a></li></ul></li><li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></li></ul><h2 id="一、Paxos-背景"><a href="#一、Paxos-背景" class="headerlink" title="一、Paxos 背景"></a>一、Paxos 背景</h2><p>Paxos 是 Leslie Lamport 于 1990 年提出的一种基于消息传递且具有高度容错特性的共识（consensus）算法。</p><p>为描述 Paxos 算法，Lamport 虚拟了一个叫做 Paxos 的希腊城邦，这个岛按照议会民主制的政治模式制订法律，但是没有人愿意将自己的全部时间和精力放在这种事情上。所以无论是议员，议长或者传递纸条的服务员都不能承诺别人需要时一定会出现，也无法承诺批准决议或者传递消息的时间。</p><h2 id="二、Basic-Paxos-算法"><a href="#二、Basic-Paxos-算法" class="headerlink" title="二、Basic Paxos 算法"></a>二、Basic Paxos 算法</h2><h3 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h3><p>Paxos 将分布式系统中的节点分为以下角色：</p><ul><li><strong>提议者（Proposer）</strong>：发出提案（Proposal）。Proposal 信息包括提案编号 (Proposal ID) 和提议的值 (Value)。</li><li><strong>决策者（Acceptor）</strong>：参与决策，回应 Proposer 的提案。收到 Proposal 后可以接受提案，若 Proposal 获得多数 Acceptor 的接受，则称该 Proposal 被批准。</li><li><strong>学习者（Learner）</strong>：不参与决策，从 Proposers/Acceptors 学习最新达成一致的提案（Value）。</li></ul><p>在复制状态机中，每个副本都同时具有 Proposer、Acceptor、Learner 三种角色。</p><p><img src="https://cdn.jsdelivr.net/gh/cntotemdb/ih1@master/202106/VKR9Qt.png" alt="img"></p><h3 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h3><p>Paxos 算法通过一个决议分为两个阶段（Learn 阶段之前决议已经形成）：</p><ol><li>第一阶段：Prepare 阶段。Proposer 向 Acceptors 发出 Prepare 请求，Acceptors 针对收到的 Prepare 请求进行 Promise 承诺。</li><li>第二阶段：Accept 阶段。Proposer 收到多数 Acceptors 承诺的 Promise 后，向 Acceptors 发出 Propose 请求，Acceptors 针对收到的 Propose 请求进行 Accept 处理。</li><li>第三阶段：Learn 阶段。Proposer 在收到多数 Acceptors 的 Accept 之后，标志着本次 Accept 成功，决议形成，将形成的决议发送给所有 Learners。</li></ol><p>Paxos 算法流程中的每条消息描述如下：</p><ul><li><p><strong>Prepare</strong>: Proposer 生成全局唯一且递增的 Proposal ID (可使用时间戳加 Server ID)，向所有 Acceptors 发送 Prepare 请求，这里无需携带提案内容，只携带 Proposal ID 即可。</p></li><li><p><strong>Promise</strong>: Acceptors 收到 Prepare 请求后，做出“两个承诺，一个应答”。</p><ul><li><p>两个承诺：</p><ul><li>不再接受 Proposal ID 小于等于当前请求的 Prepare 请求。</li><li>不再接受 Proposal ID 小于当前请求的 Propose 请求。</li></ul></li><li><p>一个应答：</p><ul><li>不违背以前作出的承诺下，回复已经 Accept 过的提案中 Proposal ID 最大的那个提案的 Value 和 Proposal ID，没有则返回空值。</li></ul></li></ul></li><li><p><strong>Propose</strong>: Proposer 收到多数 Acceptors 的 Promise 应答后，从应答中选择 Proposal ID 最大的提案的 Value，作为本次要发起的提案。如果所有应答的提案 Value 均为空值，则可以自己随意决定提案 Value。然后携带当前 Proposal ID，向所有 Acceptors 发送 Propose 请求。</p></li><li><p><strong>Accept</strong>: Acceptor 收到 Propose 请求后，在不违背自己之前作出的承诺下，接受并持久化当前 Proposal ID 和提案 Value。</p></li><li><p><strong>Learn</strong>: Proposer 收到多数 Acceptors 的 Accept 后，决议形成，将形成的决议发送给所有 Learners。</p></li></ul><h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><h4 id="Paxos-算法实例-1"><a href="#Paxos-算法实例-1" class="headerlink" title="Paxos 算法实例 1"></a>Paxos 算法实例 1</h4><p>下面举几个例子，实例 1 如下图：</p><p><img src="https://cdn.jsdelivr.net/gh/cntotemdb/ih1@master/202106/t2oEsv.jpg" alt="img"></p><p>图中 P 代表 Prepare 阶段，A 代表 Accept 阶段。3.1 代表 Proposal ID 为 3.1，其中 3 为时间戳，1 为 Server ID。X 和 Y 代表提议 Value。</p><p>实例 1 中 P 3.1 达成多数派，其 Value(X)被 Accept，然后 P 4.5 学习到 Value(X)，并 Accept。</p><p><img src="https://cdn.jsdelivr.net/gh/cntotemdb/ih1@master/202106/VjLFIS.jpg" alt="img">Paxos 算法实例 2</p><p>实例 2 中 P 3.1 没有被多数派 Accept（只有 S3 Accept），但是被 P 4.5 学习到，P 4.5 将自己的 Value 由 Y 替换为 X，Accept（X）。</p><p><img src="https://cdn.jsdelivr.net/gh/cntotemdb/ih1@master/202106/1Xty7N.jpg" alt="img">Paxos 算法实例 3</p><p>实例 3 中 P 3.1 没有被多数派 Accept（只有 S1 Accept），同时也没有被 P 4.5 学习到。由于 P 4.5 Propose 的所有应答，均未返回 Value，则 P 4.5 可以 Accept 自己的 Value (Y)。后续 P 3.1 的 Accept (X) 会失败，已经 Accept 的 S1，会被覆盖。</p><p>Paxos 算法可能形成活锁而永远不会结束，如下图实例所示：</p><p><img src="https://cdn.jsdelivr.net/gh/cntotemdb/ih1@master/202106/EPcjMs.jpg" alt="img">Paxos 算法形成活锁</p><p>回顾两个承诺之一，Acceptor 不再应答 Proposal ID 小于等于当前请求的 Prepare 请求。意味着需要应答 Proposal ID 大于当前请求的 Prepare 请求。</p><p>两个 Proposers 交替 Prepare 成功，而 Accept 失败，形成活锁（Livelock）。</p><h2 id="三、Multi-Paxos-算法"><a href="#三、Multi-Paxos-算法" class="headerlink" title="三、Multi Paxos 算法"></a>三、Multi Paxos 算法</h2><h3 id="Basic-Paxos-的问题"><a href="#Basic-Paxos-的问题" class="headerlink" title="Basic Paxos 的问题"></a>Basic Paxos 的问题</h3><p>Basic Paxos 有以下问题，导致它不能应用于实际：</p><ul><li><strong>Basic Paxos 算法只能对一个值形成决议</strong>。</li><li><strong>Basic Paxos 算法会消耗大量网络带宽</strong>。Basic Paxos 中，决议的形成至少需要两次网络通信，在高并发情况下可能需要更多的网络通信，极端情况下甚至可能形成活锁。如果想连续确定多个值，Basic Paxos 搞不定了。</li></ul><h3 id="Multi-Paxos-的改进"><a href="#Multi-Paxos-的改进" class="headerlink" title="Multi Paxos 的改进"></a>Multi Paxos 的改进</h3><p>Multi Paxos 正是为解决以上问题而提出。Multi Paxos 基于 Basic Paxos 做了两点改进：</p><ul><li>针对每一个要确定的值，运行一次 Paxos 算法实例（Instance），形成决议。每一个 Paxos 实例使用唯一的 Instance ID 标识。</li><li>在所有 Proposer 中选举一个 Leader，由 Leader 唯一地提交 Proposal 给 Acceptor 进行表决。这样没有 Proposer 竞争，解决了活锁问题。在系统中仅有一个 Leader 进行 Value 提交的情况下，Prepare 阶段就可以跳过，从而将两阶段变为一阶段，提高效率。</li></ul><p>Multi Paxos 首先需要选举 Leader，Leader 的确定也是一次决议的形成，所以可执行一次 Basic Paxos 实例来选举出一个 Leader。选出 Leader 之后只能由 Leader 提交 Proposal，在 Leader 宕机之后服务临时不可用，需要重新选举 Leader 继续服务。在系统中仅有一个 Leader 进行 Proposal 提交的情况下，Prepare 阶段可以跳过。</p><p>Multi Paxos 通过改变 Prepare 阶段的作用范围至后面 Leader 提交的所有实例，从而使得 Leader 的连续提交只需要执行一次 Prepare 阶段，后续只需要执行 Accept 阶段，将两阶段变为一阶段，提高了效率。为了区分连续提交的多个实例，每个实例使用一个 Instance ID 标识，Instance ID 由 Leader 本地递增生成即可。</p><p>Multi Paxos 允许有多个自认为是 Leader 的节点并发提交 Proposal 而不影响其安全性，这样的场景即退化为 Basic Paxos。</p><p>Chubby 和 Boxwood 均使用 Multi Paxos。ZooKeeper 使用的 Zab 也是 Multi Paxos 的变形。</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a class="link" target="_blank" rel="noopener" href="https://lamport.azurewebsites.net/pubs/paxos-simple.pdf">Paxos Made Simple 论文<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" target="_blank" rel="noopener" href="https://www.jdon.com/artichect/paxos.html">分布式系统 Paxos 算法<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/31780743">Paxos 算法详解<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" target="_blank" rel="noopener" href="https://zh.wikipedia.org/w/index.php?title=Paxos%E7%AE%97%E6%B3%95">Wiki - Paxos 算法<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" target="_blank" rel="noopener" href="https://www.bilibili.com/video/av36556594">Raft 作者讲解 Paxos 视频<i class="fas fa-external-link-alt"></i></a></li></ul></div><div class="article-nav"><div class="article-prev"><a class="prev" rel="prev" href="../8d57a79eef48/"><span class="left arrow-icon flex-center"><i class="fas fa-chevron-left"></i> </span><span class="title flex-center"><span class="post-nav-title-item">网络通信之 VPN</span> <span class="post-nav-item">上一篇</span></span></a></div><div class="article-next"><a class="next" rel="next" href="../cb036d4ded3f/"><span class="title flex-center"><span class="post-nav-title-item">分布式基础原理</span> <span class="post-nav-item">下一篇</span> </span><span class="right arrow-icon flex-center"><i class="fas fa-chevron-right"></i></span></a></div></div></div></div></div></div><div class="page-main-content-bottom"><footer class="footer"><div class="info-container"><div class="copyright-info info-item">&copy; <span>2021</span>&nbsp;-&nbsp; 2021&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">九天图腾</a></div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="website-count info-item"><span id="busuanzi_container_site_uv">访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp; </span><span id="busuanzi_container_site_pv">总访问量&nbsp;<span id="busuanzi_value_site_pv"></span></span></div><div class="theme-info info-item">由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.3</a></div></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="tools-list"><li class="tools-item page-aside-toggle"><i class="fas fa-outdent"></i></li></ul></div></div><div class="right-bottom-side-tools"><div class="side-tools-container"><ul class="side-tools-list"><li class="tools-item tool-font-adjust-plus flex-center"><i class="fas fa-search-plus"></i></li><li class="tools-item tool-font-adjust-minus flex-center"><i class="fas fa-search-minus"></i></li><li class="tools-item tool-expand-width flex-center"><i class="fas fa-arrows-alt-h"></i></li><li class="tools-item tool-dark-light-toggle flex-center"><i class="fas fa-moon"></i></li><li class="tools-item tool-scroll-to-bottom flex-center"><i class="fas fa-arrow-down"></i></li></ul><ul class="exposed-tools-list"><li class="tools-item tool-toggle-show flex-center"><i class="fas fa-cog fa-spin"></i></li><li class="tools-item tool-scroll-to-top flex-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><aside class="page-aside"><div class="post-toc-wrap"><div class="post-toc"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E5%85%B1%E8%AF%86%E6%80%A7%E7%AE%97%E6%B3%95-Paxos"><span class="nav-text">深入剖析共识性算法 Paxos</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81Paxos-%E8%83%8C%E6%99%AF"><span class="nav-text">一、Paxos 背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81Basic-Paxos-%E7%AE%97%E6%B3%95"><span class="nav-text">二、Basic Paxos 算法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%92%E8%89%B2"><span class="nav-text">角色</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%97%E6%B3%95"><span class="nav-text">算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E4%BE%8B"><span class="nav-text">实例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Paxos-%E7%AE%97%E6%B3%95%E5%AE%9E%E4%BE%8B-1"><span class="nav-text">Paxos 算法实例 1</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81Multi-Paxos-%E7%AE%97%E6%B3%95"><span class="nav-text">三、Multi Paxos 算法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Basic-Paxos-%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-text">Basic Paxos 的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Multi-Paxos-%E7%9A%84%E6%94%B9%E8%BF%9B"><span class="nav-text">Multi Paxos 的改进</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></li></ol></div></div></aside><div class="image-viewer-container"><img src=""></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fas fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fas fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/dark-light-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/local-search.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/code-copy.js"></script><div class="post-scripts"><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/toc.js"></script></div></body></html>