<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="ä¹å¤©å›¾è…¾,åšå®¢"><meta name="description" content="ä¹å¤©å›¾è…¾ä¸ªäººåšå®¢"><meta name="author" content="ä¹å¤©å›¾è…¾"><title>é™æµç®—æ³• | ä¹å¤©å›¾è…¾</title><link rel="stylesheet" href="../css/style.css"><link rel="shortcut icon" href="../images/logo.svg"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/css/font-awesome.min.css"><script id="hexo-configurations">let KEEP=window.KEEP||{};KEEP.hexo_config={hostname:"blog.yusei.zone",root:"/",language:"zh-CN",path:"search.xml"},KEEP.theme_config={toc:{enable:!0,number:!1,expand_all:!1,init_open:!1},style:{primary_color:"#0066CC",avatar:"/images/avatar.jpeg",favicon:"/images/logo.svg",article_img_align:"center",left_side_width:"260px",content_max_width:"920px",hover:{shadow:!0,scale:!0},first_screen:{enable:!0,background_img:"/images/bg.svg",description:"æ‰€è°“å“è¶Šï¼Œå¹¶éæŒ‡è¡Œä¸ºï¼Œè€Œæ˜¯ä¹ æƒ¯ã€‚"},scroll:{progress_bar:{enable:!0},percent:{enable:!0}}},local_search:{enable:!0,preload:!0},code_copy:{enable:!0,style:"default"},pjax:{enable:!1},lazyload:{enable:!1},version:"3.4.3"},KEEP.language_ago={second:"%s ç§’å‰",minute:"%s åˆ†é’Ÿå‰",hour:"%s å°æ—¶å‰",day:"%s å¤©å‰",week:"%s å‘¨å‰",month:"%s æœˆå‰",year:"%s å¹´å‰"}</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="atom.xml" title="ä¹å¤©å›¾è…¾" type="application/atom+xml">
</head><body><div class="progress-bar-container"><span class="scroll-progress-bar"></span></div><main class="page-container"><div class="page-main-content"><div class="page-main-content-top"><header class="header-wrapper"><div class="header-content"><div class="left"><a class="logo-title" href="/">ä¹å¤©å›¾è…¾</a></div><div class="right"><div class="pc"><ul class="menu-list"><li class="menu-item"><a href="../index.html">é¦–é¡µ</a></li><li class="menu-item"><a href="../archives">å½’æ¡£</a></li><li class="menu-item"><a href="../links">å‹é“¾</a></li><li class="menu-item"><a href="../about">å…³äº</a></li><li class="menu-item search search-popup-trigger"><i class="fas fa-search"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div><div class="icon-item menu-bar"><div class="menu-bar-middle"></div></div></div></div></div><div class="header-drawer"><ul class="drawer-menu-list"><li class="drawer-menu-item flex-center"><a href="../index.html">é¦–é¡µ</a></li><li class="drawer-menu-item flex-center"><a href="../archives">å½’æ¡£</a></li><li class="drawer-menu-item flex-center"><a href="../links">å‹é“¾</a></li><li class="drawer-menu-item flex-center"><a href="../about">å…³äº</a></li></ul></div><div class="window-mask"></div></header></div><div class="page-main-content-middle"><div class="main-content"><div class="fade-in-down-animation"><div class="article-content-container"><div class="article-title"><span class="title-hover-animation">é™æµç®—æ³•</span></div><div class="article-header"><div class="avatar"><img src="../images/avatar.jpeg"></div><div class="info"><div class="author"><span class="name">ä¹å¤©å›¾è…¾</span> <span class="author-label">åŒ–å¢ƒæœŸ</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fas fa-edit"></i>&nbsp;2020-01-20 11:06:00 </span><span class="article-categories article-meta-item"><i class="fas fa-folder"></i>&nbsp;<ul><li><a href="../categories/%E5%88%86%E5%B8%83%E5%BC%8F/">åˆ†å¸ƒå¼</a>&nbsp;</li></ul></span><span class="article-tags article-meta-item"><i class="fas fa-tags"></i>&nbsp;<ul><li><a href="../tags/%E5%88%86%E5%B8%83%E5%BC%8F/">åˆ†å¸ƒå¼</a>&nbsp;</li><li>| <a href="../tags/%E9%99%90%E6%B5%81/">é™æµ</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fas fa-file-word"></i>&nbsp;<span>2.7k å­—</span> </span><span class="article-min2read article-meta-item"><i class="fas fa-clock"></i>&nbsp;<span>10 åˆ†é’Ÿ</span> </span><span class="article-pv article-meta-item"><i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content markdown-body"><h1 id="é™æµç®—æ³•"><a href="#é™æµç®—æ³•" class="headerlink" title="é™æµç®—æ³•"></a>é™æµç®—æ³•</h1><blockquote><p>åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¸ºäº†åº”å¯¹ç¬æ—¶æµ·é‡è¯·æ±‚çš„å‹åŠ›ï¼Œä¿éšœç³»ç»Ÿçš„å¹³ç¨³è¿è¡Œï¼Œå¿…é¡»é¢„ä¼°ç³»ç»Ÿçš„æµé‡é˜ˆå€¼ï¼Œé€šè¿‡é™æµè§„åˆ™é˜»æ–­å¤„ç†ä¸è¿‡æ¥çš„è¯·æ±‚ã€‚</p><p>ğŸ“¦ æœ¬æ–‡å·²å½’æ¡£åˆ°ï¼šã€Œ<a class="link" target="_blank" rel="noopener" href="https://github.com/dunwu/blog">blog<i class="fas fa-external-link-alt"></i></a>ã€</p></blockquote><ul><li><a href="#%E4%B8%80%E9%99%90%E6%B5%81%E7%AE%80%E4%BB%8B">ä¸€ã€é™æµç®€ä»‹</a></li><li><a href="#%E4%BA%8C%E8%AE%A1%E6%95%B0%E5%99%A8%E6%B3%95">äºŒã€è®¡æ•°å™¨æ³•</a></li><li><a href="#%E4%B8%89%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E6%B3%95">ä¸‰ã€æ»‘åŠ¨çª—å£æ³•</a></li><li><a href="#%E5%9B%9B%E4%BB%A4%E7%89%8C%E6%A1%B6%E6%B3%95">å››ã€ä»¤ç‰Œæ¡¶æ³•</a></li><li><a href="#%E4%BA%94%E6%BC%8F%E6%A1%B6%E6%B3%95">äº”ã€æ¼æ¡¶æ³•</a></li><li><a href="#%E5%85%AD%E9%99%90%E6%B5%81%E5%B7%A5%E5%85%B7">å…­ã€é™æµå·¥å…·</a></li><li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">å‚è€ƒèµ„æ–™</a></li></ul><h2 id="ä¸€ã€é™æµç®€ä»‹"><a href="#ä¸€ã€é™æµç®€ä»‹" class="headerlink" title="ä¸€ã€é™æµç®€ä»‹"></a>ä¸€ã€é™æµç®€ä»‹</h2><p>é™æµå¯ä»¥è®¤ä¸ºæ˜¯æœåŠ¡é™çº§çš„ä¸€ç§ã€‚é™æµå°±æ˜¯<strong>é™åˆ¶ç³»ç»Ÿçš„è¾“å…¥å’Œè¾“å‡ºæµé‡å·²è¾¾åˆ°ä¿æŠ¤ç³»ç»Ÿçš„ç›®çš„</strong>ã€‚ä¸€èˆ¬æ¥è¯´ç³»ç»Ÿçš„ååé‡æ˜¯å¯ä»¥è¢«æµ‹ç®—çš„ï¼Œä¸ºäº†ä¿è¯ç³»ç»Ÿçš„ç¨³å®šè¿è¡Œï¼Œä¸€æ—¦è¾¾åˆ°çš„éœ€è¦é™åˆ¶çš„é˜ˆå€¼ï¼Œå°±éœ€è¦é™åˆ¶æµé‡å¹¶é‡‡å–ä¸€äº›æªæ–½ä»¥å®Œæˆé™åˆ¶æµé‡çš„ç›®çš„ã€‚æ¯”å¦‚ï¼šå»¶è¿Ÿå¤„ç†ï¼Œæ‹’ç»å¤„ç†ï¼Œæˆ–è€…éƒ¨åˆ†æ‹’ç»å¤„ç†ç­‰ç­‰ã€‚</p><p>é™æµè§„åˆ™åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼šæ—¶é—´ç²’åº¦ï¼Œæ¥å£ç²’åº¦ï¼Œæœ€å¤§é™æµå€¼ã€‚é™æµè§„åˆ™è®¾ç½®æ˜¯å¦åˆç†ç›´æ¥å½±å“åˆ°é™æµæ˜¯å¦åˆç†æœ‰æ•ˆã€‚</p><h2 id="äºŒã€è®¡æ•°å™¨æ³•"><a href="#äºŒã€è®¡æ•°å™¨æ³•" class="headerlink" title="äºŒã€è®¡æ•°å™¨æ³•"></a>äºŒã€è®¡æ•°å™¨æ³•</h2><p>è®¡æ•°å™¨æ³•çš„<strong>åŸç†</strong>æ˜¯ï¼šè®¾ç½®ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç”¨äºç»Ÿè®¡æŒ‡å®šæ—¶é—´æ®µå†…çš„è¯·æ±‚æ•°é‡ï¼Œå¹¶åœ¨æŒ‡å®šæ—¶é—´æ®µä¹‹åé‡ç½®è®¡æ•°å™¨ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¯·æ±‚é‡è¶…è¿‡é™å®šçš„é˜ˆå€¼ï¼Œåˆ™æ‹’ç»è¯·æ±‚ã€‚</p><p>è¿™ç§ç®—æ³•çš„ç¼ºé™·æ˜¯ï¼šè¿™ç§ç®—æ³•æ˜¯é’ˆå¯¹ä¸€ä¸ªæ—¶é—´æ®µè¿›è¡Œç»Ÿè®¡ï¼Œå¦‚æœè¯·æ±‚åˆ†å¸ƒä¸å‡åŒ€ï¼Œæç«¯æƒ…å†µä¸‹ï¼Œ<strong>æ‰€æœ‰è¯·æ±‚éƒ½åœ¨æŸä¸€åˆ»æ”¶åˆ°ï¼Œè¿˜æ˜¯å¯èƒ½å‹å®ç³»ç»Ÿ</strong>ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬é™æµè§„åˆ™ä¸ºæ¯ç§’é’Ÿä¸è¶…è¿‡ 100 æ¬¡æ¥å£è¯·æ±‚ï¼Œç¬¬ä¸€ä¸ª 1s æ—¶é—´çª—å£å†…ï¼Œ100 æ¬¡æ¥å£è¯·æ±‚éƒ½é›†ä¸­åœ¨æœ€åçš„ 10ms å†…ï¼Œåœ¨ç¬¬äºŒä¸ª 1s çš„æ—¶é—´çª—å£å†…ï¼Œ100 æ¬¡æ¥å£è¯·æ±‚éƒ½é›†ä¸­åœ¨æœ€å¼€å§‹çš„ 10ms å†…ï¼Œè™½ç„¶ä¸¤ä¸ªæ—¶é—´çª—å£å†…æµé‡éƒ½ç¬¦åˆé™æµè¦æ±‚ï¼Œä½†æ˜¯åœ¨è¿™ä¸¤ä¸ªæ—¶é—´çª—å£ä¸´ç•Œçš„ 20ms å†…ä¼šé›†ä¸­æœ‰ 200 æ¬¡æ¥å£è¯·æ±‚ï¼Œå¦‚æœä¸åšé™æµï¼Œé›†ä¸­åœ¨è¿™ 20ms å†…çš„ 200 æ¬¡è¯·æ±‚å°±æœ‰å¯èƒ½å‹å®ç³»ç»Ÿã€‚</p><p>ã€ç¤ºä¾‹ã€‘ä½¿ç”¨ <code>AtomicInteger</code> å®ç°è®¡æ•°å™¨æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Counter</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœ€å¤§è®¿é—®æ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> limit = <span class="number">10</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¿é—®æ—¶é—´å·®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> timeout = <span class="number">1000</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯·æ±‚æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> time;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½“å‰è®¡æ•°å™¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> AtomicInteger reqCount = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">limit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">if</span> (now &lt; time + timeout) &#123;</span><br><span class="line">            <span class="comment">// å•ä½æ—¶é—´å†…</span></span><br><span class="line">            reqCount.addAndGet(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> reqCount.get() &lt;= limit;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// è¶…å‡ºå•ä½æ—¶é—´</span></span><br><span class="line">            time = now;</span><br><span class="line">            reqCount = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ã€ç¤ºä¾‹ã€‘åŸºäº Redis Lua è®¡æ•°é™æµç®—æ³•çš„å®ç°</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å®ç°åŸç†</span></span><br><span class="line"><span class="comment">-- æ¯æ¬¡è¯·æ±‚éƒ½å°†å½“å‰æ—¶é—´ï¼Œç²¾ç¡®åˆ°ç§’ä½œä¸º key æ”¾å…¥ Redis ä¸­ï¼Œè¶…æ—¶æ—¶é—´è®¾ç½®ä¸º 2sï¼Œ Redis å°†è¯¥ key çš„å€¼è¿›è¡Œè‡ªå¢</span></span><br><span class="line"><span class="comment">-- å½“è¾¾åˆ°é˜ˆå€¼æ—¶è¿”å›é”™è¯¯ï¼Œè¡¨ç¤ºè¯·æ±‚è¢«é™æµ</span></span><br><span class="line"><span class="comment">-- å†™å…¥ Redis çš„æ“ä½œç”¨ Lua è„šæœ¬æ¥å®Œæˆï¼Œåˆ©ç”¨ Redis çš„å•çº¿ç¨‹æœºåˆ¶å¯ä»¥ä¿è¯æ¯ä¸ª Redis è¯·æ±‚çš„åŸå­æ€§</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- èµ„æºå”¯ä¸€æ ‡å¿—ä½</span></span><br><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>]</span><br><span class="line"><span class="comment">-- é™æµå¤§å°</span></span><br><span class="line"><span class="keyword">local</span> limit = <span class="built_in">tonumber</span>(ARGV[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">-- è·å–å½“å‰æµé‡å¤§å°</span></span><br><span class="line"><span class="keyword">local</span> currentLimit = <span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, key) <span class="keyword">or</span> <span class="string">&quot;0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> currentLimit + <span class="number">1</span> &gt; limit <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- è¾¾åˆ°é™æµå¤§å° è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment">-- æ²¡æœ‰è¾¾åˆ°é˜ˆå€¼ value + 1</span></span><br><span class="line">    redis.call(<span class="string">&quot;INCRBY&quot;</span>, key, <span class="number">1</span>)</span><br><span class="line">    <span class="comment">-- è®¾ç½®è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    redis.call(<span class="string">&quot;EXPIRE&quot;</span>, key, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> currentLimit + <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="ä¸‰ã€æ»‘åŠ¨çª—å£æ³•"><a href="#ä¸‰ã€æ»‘åŠ¨çª—å£æ³•" class="headerlink" title="ä¸‰ã€æ»‘åŠ¨çª—å£æ³•"></a>ä¸‰ã€æ»‘åŠ¨çª—å£æ³•</h2><p>æ»‘åŠ¨çª—å£æ³•çš„<strong>åŸç†</strong>ï¼š</p><p>æ»‘åŠ¨çª—å£æ³•æ˜¯è®¡æ•°å™¨ç®—æ³•çš„ä¸€ç§æ”¹è¿›ï¼Œ<strong>å¢åŠ ä¸€ä¸ªæ—¶é—´ç²’åº¦çš„åº¦é‡å•ä½ï¼Œå°†åŸæ¥çš„ä¸€ä¸ªæ—¶é—´çª—å£åˆ’åˆ†æˆå¤šä¸ªæ—¶é—´çª—å£ï¼Œå¹¶ä¸”ä¸æ–­å‘å³æ»‘åŠ¨è¯¥çª—å£</strong>ã€‚æµé‡ç»è¿‡æ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•æ•´å½¢ä¹‹åï¼Œå¯ä»¥ä¿è¯ä»»æ„æ—¶é—´çª—å£å†…ï¼Œéƒ½ä¸ä¼šè¶…è¿‡æœ€å¤§å…è®¸çš„é™æµå€¼ï¼Œä»æµé‡æ›²çº¿ä¸Šæ¥çœ‹ä¼šæ›´åŠ å¹³æ»‘ï¼Œå¯ä»¥éƒ¨åˆ†è§£å†³ä¸Šé¢æåˆ°çš„ä¸´ç•Œçªå‘æµé‡é—®é¢˜ã€‚</p><p>å¯¹æ¯”å›ºå®šæ—¶é—´çª—å£é™æµç®—æ³•ï¼Œæ»‘åŠ¨æ—¶é—´çª—å£é™æµç®—æ³•çš„æ—¶é—´çª—å£æ˜¯æŒç»­æ»‘åŠ¨çš„ï¼Œå¹¶ä¸”é™¤äº†éœ€è¦ä¸€ä¸ªè®¡æ•°å™¨æ¥è®°å½•æ—¶é—´çª—å£å†…æ¥å£è¯·æ±‚æ¬¡æ•°ä¹‹å¤–ï¼Œè¿˜éœ€è¦è®°å½•åœ¨æ—¶é—´çª—å£å†…æ¯ä¸ªæ¥å£è¯·æ±‚åˆ°è¾¾çš„æ—¶é—´ç‚¹ï¼Œå¯¹å†…å­˜çš„å ç”¨ä¼šæ¯”è¾ƒå¤šã€‚ åœ¨ä¸´ç•Œä½ç½®çš„çªå‘è¯·æ±‚éƒ½ä¼šè¢«ç®—åˆ°æ—¶é—´çª—å£å†…ï¼Œå› æ­¤å¯ä»¥è§£å†³è®¡æ•°å™¨ç®—æ³•çš„ä¸´ç•Œé—®é¢˜ï¼Œ</p><p>æ¯”å¦‚åœ¨ä¸Šæ–‡çš„ä¾‹å­ä¸­ï¼Œé€šè¿‡æ»‘åŠ¨çª—å£ç®—æ³•æ•´å‹åï¼Œç¬¬ä¸€ä¸ª 1s çš„æ—¶é—´çª—å£çš„ 100 æ¬¡è¯·æ±‚éƒ½ä¼šé€šè¿‡ï¼Œç¬¬äºŒä¸ªæ—¶é—´çª—å£æœ€å¼€å§‹çš„ 10ms å†…çš„ 100 ä¸ªè¯·æ±‚éƒ½ä¼šè¢«é™æµç†”æ–­ã€‚</p><p>æ»‘åŠ¨çª—å£æ³•çš„<strong>ç¼ºé™·</strong>ï¼šåŸºäºæ—¶é—´çª—å£çš„é™æµç®—æ³•ï¼Œ<strong>åªèƒ½åœ¨é€‰å®šçš„æ—¶é—´ç²’åº¦ä¸Šé™æµï¼Œå¯¹é€‰å®šæ—¶é—´ç²’åº¦å†…çš„æ›´åŠ ç»†ç²’åº¦çš„è®¿é—®é¢‘ç‡ä¸åšé™åˆ¶</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentLinkedQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.IntStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeWindow</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ConcurrentLinkedQueue&lt;Long&gt; queue = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;Long&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é—´éš”ç§’æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> seconds;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœ€å¤§é™æµ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> max;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TimeWindow</span><span class="params">(<span class="keyword">int</span> max, <span class="keyword">int</span> seconds)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seconds = seconds;</span><br><span class="line">        <span class="keyword">this</span>.max = max;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æ°¸ç»­çº¿ç¨‹æ‰§è¡Œæ¸…ç†queue ä»»åŠ¡</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// ç­‰å¾… é—´éš”ç§’æ•°-1 æ‰§è¡Œæ¸…ç†æ“ä½œ</span></span><br><span class="line">                    Thread.sleep((seconds - <span class="number">1</span>) * <span class="number">1000L</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                clean();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> TimeWindow timeWindow = <span class="keyword">new</span> TimeWindow(<span class="number">10</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æµ‹è¯•3ä¸ªçº¿ç¨‹</span></span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">3</span>).forEach((i) -&gt; &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="keyword">new</span> Random().nextInt(<span class="number">20</span>) * <span class="number">100</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    timeWindow.take();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;).start();</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–ä»¤ç‰Œï¼Œå¹¶ä¸”æ·»åŠ æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">take</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> size = sizeOfValid();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; max) &#123;</span><br><span class="line">                System.err.println(<span class="string">&quot;è¶…é™&quot;</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">synchronized</span> (queue) &#123;</span><br><span class="line">                <span class="keyword">if</span> (sizeOfValid() &gt; max) &#123;</span><br><span class="line">                    System.err.println(<span class="string">&quot;è¶…é™&quot;</span>);</span><br><span class="line">                    System.err.println(<span class="string">&quot;queueä¸­æœ‰ &quot;</span> + queue.size() + <span class="string">&quot; æœ€å¤§æ•°é‡ &quot;</span> + max);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">this</span>.queue.offer(System.currentTimeMillis());</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;queueä¸­æœ‰ &quot;</span> + queue.size() + <span class="string">&quot; æœ€å¤§æ•°é‡ &quot;</span> + max);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">sizeOfValid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Iterator&lt;Long&gt; it = queue.iterator();</span><br><span class="line">        Long ms = System.currentTimeMillis() - seconds * <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            <span class="keyword">long</span> t = it.next();</span><br><span class="line">            <span class="keyword">if</span> (t &gt; ms) &#123;</span><br><span class="line">                <span class="comment">// åœ¨å½“å‰çš„ç»Ÿè®¡æ—¶é—´èŒƒå›´å†…</span></span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¸…ç†è¿‡æœŸçš„æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Long c = System.currentTimeMillis() - seconds * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">        Long tl = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">while</span> ((tl = queue.peek()) != <span class="keyword">null</span> &amp;&amp; tl &lt; c) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æ¸…ç†æ•°æ®&quot;</span>);</span><br><span class="line">            queue.poll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å››ã€ä»¤ç‰Œæ¡¶æ³•"><a href="#å››ã€ä»¤ç‰Œæ¡¶æ³•" class="headerlink" title="å››ã€ä»¤ç‰Œæ¡¶æ³•"></a>å››ã€ä»¤ç‰Œæ¡¶æ³•</h2><p>ä»¤ç‰Œæ¡¶ç®—æ³•çš„<strong>åŸç†</strong>ï¼š</p><ol><li>æ¥å£é™åˆ¶ T ç§’å†…æœ€å¤§è®¿é—®æ¬¡æ•°ä¸º Nï¼Œåˆ™æ¯éš” T/N ç§’ä¼šæ”¾ä¸€ä¸ª token åˆ°æ¡¶ä¸­</li><li>æ¡¶å†…æœ€å¤šå­˜æ”¾ M ä¸ª tokenï¼Œå¦‚æœ token åˆ°è¾¾æ—¶ä»¤ç‰Œæ¡¶å·²ç»æ»¡äº†ï¼Œé‚£ä¹ˆè¿™ä¸ª token å°±ä¼šè¢«ä¸¢å¼ƒ</li><li>æ¥å£è¯·æ±‚ä¼šå…ˆä»ä»¤ç‰Œæ¡¶ä¸­å– tokenï¼Œæ‹¿åˆ° token åˆ™å¤„ç†æ¥å£è¯·æ±‚ï¼Œæ‹¿ä¸åˆ° token åˆ™è¿›è¡Œé™æµå¤„ç†</li></ol><p>å› ä¸ºä»¤ç‰Œæ¡¶å­˜æ”¾äº†å¾ˆå¤šä»¤ç‰Œï¼Œé‚£ä¹ˆå¤§é‡çš„çªå‘è¯·æ±‚ä¼šè¢«æ‰§è¡Œï¼Œä½†æ˜¯å®ƒä¸ä¼šå‡ºç°ä¸´ç•Œé—®é¢˜ï¼Œåœ¨ä»¤ç‰Œç”¨å®Œä¹‹åï¼Œä»¤ç‰Œæ˜¯ä»¥ä¸€ä¸ªæ’å®šçš„é€Ÿç‡æ·»åŠ åˆ°ä»¤ç‰Œæ¡¶ä¸­çš„ï¼Œå› æ­¤ä¸èƒ½å†æ¬¡å‘é€å¤§é‡çªå‘è¯·æ±‚ã€‚</p><p>è§„å®šå›ºå®šå®¹é‡çš„æ¡¶ï¼Œtoken ä»¥å›ºå®šé€Ÿåº¦å¾€æ¡¶å†…å¡«å……ï¼Œå½“æ¡¶æ»¡æ—¶ token ä¸ä¼šè¢«ç»§ç»­æ”¾å…¥ï¼Œæ¯è¿‡æ¥ä¸€ä¸ªè¯·æ±‚æŠŠ token ä»æ¡¶ä¸­ç§»é™¤,å¦‚æœæ¡¶ä¸­æ²¡æœ‰ token ä¸èƒ½è¯·æ±‚ã€‚</p><p>ã€ç¤ºä¾‹ã€‘Java å®ç°ä»¤ç‰Œæ¡¶ç®—æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenBucket</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> time;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ€»é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Double total;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * token æ”¾å…¥é€Ÿåº¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Double rate;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½“å‰æ€»é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Double nowSize;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">limit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">        nowSize = Math.min(total, nowSize + (now - time) * rate);</span><br><span class="line">        time = now;</span><br><span class="line">        <span class="keyword">if</span> (nowSize &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// æ¡¶é‡Œæ²¡æœ‰token</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å­˜åœ¨token</span></span><br><span class="line">            nowSize -= <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ã€ç¤ºä¾‹ã€‘åŸºäº Redis Lua ä»¤ç‰Œæ¡¶é™æµç®—æ³•å®ç°</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ä»¤ç‰Œæ¡¶é™æµ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ä»¤ç‰Œçš„å”¯ä¸€æ ‡è¯†</span></span><br><span class="line"><span class="keyword">local</span> bucketKey = KEYS[<span class="number">1</span>]</span><br><span class="line"><span class="comment">-- ä¸Šæ¬¡è¯·æ±‚çš„æ—¶é—´</span></span><br><span class="line"><span class="keyword">local</span> last_mill_request_key = KEYS[<span class="number">2</span>]</span><br><span class="line"><span class="comment">-- ä»¤ç‰Œæ¡¶çš„å®¹é‡</span></span><br><span class="line"><span class="keyword">local</span> limit = <span class="built_in">tonumber</span>(ARGV[<span class="number">1</span>])</span><br><span class="line"><span class="comment">-- è¯·æ±‚ä»¤ç‰Œçš„æ•°é‡</span></span><br><span class="line"><span class="keyword">local</span> permits = <span class="built_in">tonumber</span>(ARGV[<span class="number">2</span>])</span><br><span class="line"><span class="comment">-- ä»¤ç‰Œæµå…¥çš„é€Ÿç‡</span></span><br><span class="line"><span class="keyword">local</span> rate = <span class="built_in">tonumber</span>(ARGV[<span class="number">3</span>])</span><br><span class="line"><span class="comment">-- å½“å‰æ—¶é—´</span></span><br><span class="line"><span class="keyword">local</span> curr_mill_time = <span class="built_in">tonumber</span>(ARGV[<span class="number">4</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ·»åŠ ä»¤ç‰Œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- è·å–å½“å‰ä»¤ç‰Œçš„æ•°é‡</span></span><br><span class="line"><span class="keyword">local</span> current_limit = <span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, bucketKey) <span class="keyword">or</span> <span class="string">&quot;0&quot;</span>)</span><br><span class="line"><span class="comment">-- è·å–ä¸Šæ¬¡è¯·æ±‚çš„æ—¶é—´</span></span><br><span class="line"><span class="keyword">local</span> last_mill_request_time = <span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, last_mill_request_key) <span class="keyword">or</span> <span class="string">&quot;0&quot;</span>)</span><br><span class="line"><span class="comment">-- è®¡ç®—å‘æ¡¶é‡Œæ·»åŠ ä»¤ç‰Œçš„æ•°é‡</span></span><br><span class="line"><span class="keyword">if</span> last_mill_request_time == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">	<span class="comment">-- ä»¤ç‰Œæ¡¶åˆå§‹åŒ–</span></span><br><span class="line">	<span class="comment">-- æ›´æ–°ä¸Šæ¬¡è¯·æ±‚æ—¶é—´</span></span><br><span class="line">	redis.call(<span class="string">&quot;HSET&quot;</span>, last_mill_request_key, curr_mill_time)</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="keyword">local</span> add_token_num = <span class="built_in">math</span>.<span class="built_in">floor</span>((curr_mill_time - last_mill_request_time) * rate)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ›´æ–°ä»¤ç‰Œçš„æ•°é‡</span></span><br><span class="line"><span class="keyword">if</span> current_limit + add_token_num &gt; limit <span class="keyword">then</span></span><br><span class="line">    current_limit = limit</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	current_limit = current_limit + add_token_num</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">	redis.<span class="built_in">pcall</span>(<span class="string">&quot;HSET&quot;</span>,bucketKey, current_limit)</span><br><span class="line"><span class="comment">-- è®¾ç½®è¿‡æœŸæ—¶é—´</span></span><br><span class="line">redis.call(<span class="string">&quot;EXPIRE&quot;</span>, bucketKey, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- é™æµåˆ¤æ–­</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> current_limit - permits &lt; <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- è¾¾åˆ°é™æµå¤§å°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment">-- æ²¡æœ‰è¾¾åˆ°é™æµå¤§å°</span></span><br><span class="line">	current_limit = current_limit - permits</span><br><span class="line">	redis.<span class="built_in">pcall</span>(<span class="string">&quot;HSET&quot;</span>, bucketKey, current_limit)</span><br><span class="line">    <span class="comment">-- è®¾ç½®è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    redis.call(<span class="string">&quot;EXPIRE&quot;</span>, bucketKey, <span class="number">2</span>)</span><br><span class="line">	<span class="comment">-- æ›´æ–°ä¸Šæ¬¡è¯·æ±‚çš„æ—¶é—´</span></span><br><span class="line">	redis.call(<span class="string">&quot;HSET&quot;</span>, last_mill_request_key, curr_mill_time)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="äº”ã€æ¼æ¡¶æ³•"><a href="#äº”ã€æ¼æ¡¶æ³•" class="headerlink" title="äº”ã€æ¼æ¡¶æ³•"></a>äº”ã€æ¼æ¡¶æ³•</h2><p>ç›¸æ¯”äºä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œæ¼æ¡¶æ³•å¯¹äºå–ä»¤ç‰Œçš„é¢‘ç‡ä¹Ÿæœ‰é™åˆ¶ï¼Œè¦æŒ‰ç…§ T/N çš„å›ºå®šé€Ÿç‡æ¥å–ä»¤ç‰Œ ã€‚</p><p>ä»¤ç‰Œæ¡¶ç®—æ³•å’Œæ¼æ¡¶ç®—æ³•å¯¹æµé‡çš„æ•´å½¢æ•ˆæœæ¯”è¾ƒå¥½ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯æ•´å‹æ•ˆæœå¥½å°±è¶Šåˆé€‚ï¼Œå¯¹äºæ²¡æœ‰æå‰é¢„çƒ­çš„ä»¤ç‰Œæ¡¶ï¼Œå¦‚æœåšå¦å†³å¼é™æµï¼Œä¼šå¯¼è‡´è¯¯æ€å¾ˆå¤šè¯·æ±‚ã€‚ä¸Šè¿°ç®—æ³•ä¸­å½“ n æ¯”è¾ƒå°æ—¶ï¼Œæ¯”å¦‚ 50ï¼Œé—´éš” 20ms æ‰ä¼šå‘æ¡¶ä¸­æ”¾å…¥ä¸€ä¸ªä»¤ç‰Œï¼Œè€Œæ¥å£çš„è®¿é—®åœ¨ 1s å†…å¯èƒ½éšæœºæ€§å¾ˆå¼ºï¼Œè¿™å°±ä¼šå‡ºç°ï¼šå°½ç®¡ä»æ›²çº¿ä¸Šçœ‹å¯¹æœ€å¤§è®¿é—®é¢‘ç‡çš„é™åˆ¶å¾ˆæœ‰æ•ˆï¼Œæµé‡åœ¨ç»†æ—¶é—´ç²’åº¦ä¸Šé¢éƒ½å¾ˆå¹³æ»‘ï¼Œä½†æ˜¯è¯¯æ€äº†å¾ˆå¤šæœ¬ä¸åº”è¯¥æ‹’ç»çš„æ¥å£è¯·æ±‚ã€‚</p><p>ã€ç¤ºä¾‹ã€‘æ¼æ¡¶æ³•å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LeakBucket</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> time;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ€»é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Double total;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ°´æµå‡ºå»çš„é€Ÿåº¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Double rate;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½“å‰æ€»é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Double nowSize;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">limit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">        nowSize = Math.max(<span class="number">0</span>, (nowSize - (now - time) * rate));</span><br><span class="line">        time = now;</span><br><span class="line">        <span class="keyword">if</span> ((nowSize + <span class="number">1</span>) &lt; total) &#123;</span><br><span class="line">            nowSize++;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…­ã€é™æµå·¥å…·"><a href="#å…­ã€é™æµå·¥å…·" class="headerlink" title="å…­ã€é™æµå·¥å…·"></a>å…­ã€é™æµå·¥å…·</h2><p>å‰é¢ä»‹ç»äº†é™æµç®—æ³•çš„åŸºæœ¬åŸç†å’Œä¸€äº›ç®€å•çš„å®ç°ã€‚ä½†åœ¨ç”Ÿäº§ç¯å¢ƒï¼Œæˆ‘ä»¬ä¸€èˆ¬åº”è¯¥ä½¿ç”¨æ›´æˆç†Ÿçš„é™æµå·¥å…·ã€‚</p><ul><li>Guava çš„ <code>RateLimiter</code>ï¼šRateLimiter åŸºäºæ¼æ¡¶ç®—æ³•ï¼Œä½†å®ƒå‚è€ƒäº†ä»¤ç‰Œæ¡¶ç®—æ³•ã€‚å…·ä½“ç”¨æ³•å¯ä»¥å‚è€ƒï¼š<a class="link" target="_blank" rel="noopener" href="https://blog.csdn.net/forezp/article/details/100060686">RateLimiter åŸºäºæ¼æ¡¶ç®—æ³•ï¼Œä½†å®ƒå‚è€ƒäº†ä»¤ç‰Œæ¡¶ç®—æ³•<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" target="_blank" rel="noopener" href="https://github.com/Netflix/Hystrix">Hystrix<i class="fas fa-external-link-alt"></i></a>ï¼šç»å…¸çš„é™æµã€ç†”æ–­å·¥å…·ï¼Œå¾ˆå€¼å¾—å€Ÿé‰´å­¦ä¹ ã€‚æ³¨ï¼šå®˜æ–¹å·²åœæ­¢å‘å¸ƒç‰ˆæœ¬ã€‚</li><li><a class="link" target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel">Sentinel<i class="fas fa-external-link-alt"></i></a>ï¼šé˜¿é‡Œçš„é™æµã€ç†”æ–­å·¥å…·ã€‚</li></ul><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><a class="link" target="_blank" rel="noopener" href="https://item.jd.com/11322972.html">ã€Šå¤§å‹ç½‘ç«™æŠ€æœ¯æ¶æ„ï¼šæ ¸å¿ƒåŸç†ä¸æ¡ˆä¾‹åˆ†æã€‹<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" target="_blank" rel="noopener" href="https://www.jianshu.com/p/76cc8ba5ca91">è°ˆè°ˆé™æµç®—æ³•çš„å‡ ç§å®ç°<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" target="_blank" rel="noopener" href="https://github.com/doocs/advanced-java/blob/master/docs/high-concurrency/huifer-how-to-limit-current.md">å¦‚ä½•é™æµï¼Ÿåœ¨å·¥ä½œä¸­æ˜¯æ€ä¹ˆåšçš„ï¼Ÿè¯´ä¸€ä¸‹å…·ä½“çš„å®ç°ï¼Ÿ<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" target="_blank" rel="noopener" href="https://gongfukangee.github.io/2019/04/04/Limit/">æµ…æé™æµç®—æ³•<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" target="_blank" rel="noopener" href="https://blog.csdn.net/forezp/article/details/100060686">RateLimiter åŸºäºæ¼æ¡¶ç®—æ³•ï¼Œä½†å®ƒå‚è€ƒäº†ä»¤ç‰Œæ¡¶ç®—æ³•<i class="fas fa-external-link-alt"></i></a></li></ul></div><div class="article-nav"><div class="article-prev"><a class="prev" rel="prev" href="../d65853dfa6ec/"><span class="left arrow-icon flex-center"><i class="fas fa-chevron-left"></i> </span><span class="title flex-center"><span class="post-nav-title-item">æ·±å…¥å‰–æå…±è¯†æ€§ç®—æ³• Raft</span> <span class="post-nav-item">ä¸Šä¸€ç¯‡</span></span></a></div><div class="article-next"><a class="next" rel="next" href="../9c874347bb30/"><span class="title flex-center"><span class="post-nav-title-item">åˆ†å¸ƒå¼å­˜å‚¨åŸºæœ¬åŸç†</span> <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span> </span><span class="right arrow-icon flex-center"><i class="fas fa-chevron-right"></i></span></a></div></div></div></div></div></div><div class="page-main-content-bottom"><footer class="footer"><div class="info-container"><div class="copyright-info info-item">&copy; <span>2021</span>&nbsp;-&nbsp; 2021&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">ä¹å¤©å›¾è…¾</a></div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="website-count info-item"><span id="busuanzi_container_site_uv">è®¿é—®äººæ•°&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp; </span><span id="busuanzi_container_site_pv">æ€»è®¿é—®é‡&nbsp;<span id="busuanzi_value_site_pv"></span></span></div><div class="theme-info info-item">ç”± <a target="_blank" href="https://hexo.io">Hexo</a> é©±åŠ¨&nbsp;|&nbsp;ä¸»é¢˜&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.3</a></div></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="tools-list"><li class="tools-item page-aside-toggle"><i class="fas fa-outdent"></i></li></ul></div></div><div class="right-bottom-side-tools"><div class="side-tools-container"><ul class="side-tools-list"><li class="tools-item tool-font-adjust-plus flex-center"><i class="fas fa-search-plus"></i></li><li class="tools-item tool-font-adjust-minus flex-center"><i class="fas fa-search-minus"></i></li><li class="tools-item tool-expand-width flex-center"><i class="fas fa-arrows-alt-h"></i></li><li class="tools-item tool-dark-light-toggle flex-center"><i class="fas fa-moon"></i></li><li class="tools-item tool-scroll-to-bottom flex-center"><i class="fas fa-arrow-down"></i></li></ul><ul class="exposed-tools-list"><li class="tools-item tool-toggle-show flex-center"><i class="fas fa-cog fa-spin"></i></li><li class="tools-item tool-scroll-to-top flex-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><aside class="page-aside"><div class="post-toc-wrap"><div class="post-toc"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95"><span class="nav-text">é™æµç®—æ³•</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E9%99%90%E6%B5%81%E7%AE%80%E4%BB%8B"><span class="nav-text">ä¸€ã€é™æµç®€ä»‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E8%AE%A1%E6%95%B0%E5%99%A8%E6%B3%95"><span class="nav-text">äºŒã€è®¡æ•°å™¨æ³•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E6%B3%95"><span class="nav-text">ä¸‰ã€æ»‘åŠ¨çª—å£æ³•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E4%BB%A4%E7%89%8C%E6%A1%B6%E6%B3%95"><span class="nav-text">å››ã€ä»¤ç‰Œæ¡¶æ³•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E6%BC%8F%E6%A1%B6%E6%B3%95"><span class="nav-text">äº”ã€æ¼æ¡¶æ³•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E9%99%90%E6%B5%81%E5%B7%A5%E5%85%B7"><span class="nav-text">å…­ã€é™æµå·¥å…·</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">å‚è€ƒèµ„æ–™</span></a></li></ol></li></ol></div></div></aside><div class="image-viewer-container"><img src=""></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fas fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="æœç´¢..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fas fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/dark-light-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/local-search.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/code-copy.js"></script><div class="post-scripts"><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/toc.js"></script></div></body></html>